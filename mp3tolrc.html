<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘é¡µç‰ˆ LRC æ­Œè¯åˆ¶ä½œå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        .lyric-line {
            transition: all 0.2s ease;
        }
        .lyric-line.active {
            background-color: #374151;
            border-left: 4px solid #3b82f6;
            padding-left: 12px; 
            color: #60a5fa;
            font-weight: bold;
            transform: scale(1.02);
        }
        .lyric-line.past {
            opacity: 0.6;
        }
        /* é¢„è§ˆæ¨¡å¼ä¸‹çš„é«˜äº® */
        .preview-active {
            color: #fbbf24; /* Amber-400 */
            font-size: 1.1em;
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-screen flex flex-col overflow-hidden font-sans">

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="bg-gray-800 border-b border-gray-700 p-4 flex justify-between items-center shrink-0 shadow-md z-10">
        <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
            </svg>
            <h1 class="text-xl font-bold">LRC æ­Œè¯åˆ¶ä½œå·¥åŠ</h1>
        </div>
        <div class="flex gap-3">
            <button onclick="resetEditor()" class="px-4 py-2 text-sm text-gray-400 hover:text-white transition">é‡ç½®</button>
            <button onclick="downloadLRC()" id="downloadBtn" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded shadow flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                ä¸‹è½½ .LRC
            </button>
        </div>
    </header>

    <!-- ä¸»ä½“å†…å®¹ -->
    <main class="flex-1 flex overflow-hidden">
        
        <!-- å·¦ä¾§ï¼šè®¾ç½®ä¸æ§åˆ¶ -->
        <aside class="w-1/3 min-w-[350px] bg-gray-800 p-6 flex flex-col border-r border-gray-700 overflow-y-auto">
            
            <!-- æ­¥éª¤ 1: å¯¼å…¥ -->
            <div id="step1-container" class="space-y-6">
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h2 class="text-lg font-semibold mb-3 text-blue-400">1. å¯¼å…¥æ­Œæ›² (MP3)</h2>
                    <input type="file" id="audioInput" accept="audio/*" class="block w-full text-sm text-gray-400
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-600 file:text-white
                        hover:file:bg-blue-500
                        cursor-pointer
                    "/>
                </div>

                <div class="bg-gray-700 p-4 rounded-lg flex-1 flex flex-col">
                    <h2 class="text-lg font-semibold mb-3 text-blue-400">2. ç²˜è´´æ­Œè¯æ–‡æœ¬</h2>
                    <textarea id="rawLyrics" class="w-full h-64 bg-gray-900 text-gray-200 p-3 rounded border border-gray-600 focus:border-blue-500 focus:outline-none resize-none text-sm" placeholder="åœ¨æ­¤å¤„ç²˜è´´çº¯æ–‡æœ¬æ­Œè¯...&#10;æ¯è¡Œä¸€å¥&#10;ä¸è¦å¸¦æ—¶é—´è½´"></textarea>
                </div>

                <button onclick="startEditing()" id="startBtn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded shadow-lg transition transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    å¼€å§‹åˆ¶ä½œ / é‡æ–°åŠ è½½
                </button>
            </div>

            <!-- éŸ³é¢‘æ’­æ”¾å™¨ (å§‹ç»ˆå¯è§ä½†ä¸å¯äº¤äº’ï¼Œé€šè¿‡è‡ªå®šä¹‰æ§ä»¶æ§åˆ¶) -->
            <div class="mt-auto pt-6 border-t border-gray-600">
                <audio id="audioPlayer" class="w-full mb-4 hidden"></audio>
                
                <!-- è‡ªå®šä¹‰æ§åˆ¶é¢æ¿ -->
                <div class="bg-gray-900 p-4 rounded-xl border border-gray-700 shadow-inner">
                    <div class="flex justify-between text-xs text-gray-400 mb-1">
                        <span id="currentTimeDisplay">00:00.00</span>
                        <span id="durationDisplay">00:00.00</span>
                    </div>
                    <!-- è¿›åº¦æ¡ -->
                    <div class="w-full bg-gray-700 rounded-full h-2 mb-4 cursor-pointer relative group" id="progressBarContainer">
                        <div id="progressBar" class="bg-blue-500 h-2 rounded-full w-0 transition-all duration-100 ease-linear relative">
                            <div class="absolute right-0 -top-1 w-4 h-4 bg-white rounded-full shadow opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <button id="playPauseBtn" onclick="togglePlay()" class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded transition flex justify-center items-center gap-2">
                            <span id="playIcon">â–¶ æ’­æ”¾ (ç©ºæ ¼)</span>
                        </button>
                        <button onclick="rewind(5)" class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded transition">
                            âª åé€€ 5ç§’
                        </button>
                    </div>
                    
                    <button id="stampBtn" onclick="stampCurrentLine()" class="w-full mt-4 bg-rose-600 hover:bg-rose-500 text-white font-bold py-4 rounded-lg shadow-lg text-lg transition transform active:scale-95 border-b-4 border-rose-800 active:border-b-0 active:translate-y-1">
                        ğŸ“ æ’å…¥æ—¶é—´æ ‡ç­¾ (Enter)
                    </button>
                    <p class="text-center text-xs text-gray-500 mt-2">æç¤ºï¼šä½¿ç”¨é”®ç›˜å¿«æ·é”®æ•ˆç‡æ›´é«˜</p>
                </div>
            </div>
        </aside>

        <!-- å³ä¾§ï¼šæ­Œè¯ç¼–è¾‘å™¨åˆ—è¡¨ -->
        <section class="flex-1 bg-gray-900 relative flex flex-col">
            <!-- å¤´éƒ¨ -->
            <div class="bg-gray-800 px-6 py-3 border-b border-gray-700 flex justify-between items-center">
                <h3 class="font-semibold text-gray-300">æ­Œè¯é¢„è§ˆä¸ç¼–è¾‘åŒº</h3>
                <div class="flex items-center gap-2 text-sm">
                    <span class="w-3 h-3 bg-blue-500 rounded-full inline-block"></span> å¾…æ‰“è½´
                    <span class="w-3 h-3 bg-rose-500 rounded-full inline-block ml-2"></span> å·²æ‰“è½´
                    <span class="w-3 h-3 bg-yellow-500 rounded-full inline-block ml-2"></span> å½“å‰æ’­æ”¾
                </div>
            </div>

            <!-- åˆ—è¡¨å®¹å™¨ -->
            <div id="lyricsList" class="flex-1 overflow-y-auto p-6 space-y-1 relative">
                <div class="text-center text-gray-500 mt-20">
                    <p class="text-xl">ğŸ‘‹ æ¬¢è¿ä½¿ç”¨</p>
                    <p class="mt-2 text-sm">è¯·åœ¨å·¦ä¾§ä¸Šä¼  MP3 å¹¶ç²˜è´´æ­Œè¯ä»¥å¼€å§‹ã€‚</p>
                </div>
            </div>

            <!-- é¢„è§ˆé®ç½© (Overlay) - å¯é€‰åŠŸèƒ½ï¼Œè¿™é‡Œç›´æ¥åœ¨åˆ—è¡¨ä¸­åšé¢„è§ˆæ›´ç›´è§‚ -->
        </section>
    </main>

    <script>
        // --- å˜é‡å®šä¹‰ ---
        let audio = document.getElementById('audioPlayer');
        let lyricsData = []; // å­˜å‚¨ç»“æ„: { time: float, text: string, displayTime: string }
        let currentLineIndex = 0; // å½“å‰éœ€è¦æ‰“è½´çš„è¡Œç´¢å¼•
        let isPlaying = false;
        
        // DOM å…ƒç´ 
        const lyricsListEl = document.getElementById('lyricsList');
        const rawLyricsEl = document.getElementById('rawLyrics');
        const fileInput = document.getElementById('audioInput');
        const startBtn = document.getElementById('startBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const stampBtn = document.getElementById('stampBtn');
        const playPauseBtn = document.getElementById('playPauseBtn');
        
        // --- åˆå§‹åŒ–äº‹ä»¶ç›‘å¬ ---

        // 1. æ–‡ä»¶ä¸Šä¼ ç›‘å¬
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                audio.src = url;
                checkReadyState();
            }
        });

        // 2. æ–‡æœ¬è¾“å…¥ç›‘å¬
        rawLyricsEl.addEventListener('input', checkReadyState);

        function checkReadyState() {
            if (fileInput.files.length > 0 && rawLyricsEl.value.trim().length > 0) {
                startBtn.disabled = false;
                startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                startBtn.disabled = true;
            }
        }

        // --- æ ¸å¿ƒé€»è¾‘ï¼šå¼€å§‹åˆ¶ä½œ ---
        function startEditing() {
            const rawText = rawLyricsEl.value;
            // æŒ‰è¡Œåˆ†å‰²ï¼Œè¿‡æ»¤ç©ºè¡Œ
            const lines = rawText.split('\n').map(l => l.trim()).filter(l => l !== '');
            
            if (lines.length === 0) {
                alert('è¯·è‡³å°‘è¾“å…¥ä¸€è¡Œæ­Œè¯');
                return;
            }

            // åˆå§‹åŒ–æ•°æ®
            lyricsData = lines.map(line => ({
                text: line,
                time: null,
                displayTime: '[--:--.--]'
            }));
            
            currentLineIndex = 0;
            renderLyricsList();
            
            // æ¿€æ´»ä¸‹è½½æŒ‰é’®
            downloadBtn.disabled = false;
            
            // è‡ªåŠ¨å¼€å§‹æ’­æ”¾ï¼ˆå¯é€‰ï¼‰
            // audio.play();
            // isPlaying = true;
            // updatePlayButton();
        }

        // --- æ¸²æŸ“æ­Œè¯åˆ—è¡¨ ---
        function renderLyricsList() {
            lyricsListEl.innerHTML = '';
            
            lyricsData.forEach((item, index) => {
                const row = document.createElement('div');
                row.className = `lyric-line p-3 rounded cursor-pointer flex items-center group hover:bg-gray-800 border border-transparent ${index === currentLineIndex ? 'active' : ''}`;
                row.id = `line-${index}`;
                
                // ç‚¹å‡»è¡Œå¯ä»¥æ‰‹åŠ¨è·³è½¬è¿›åº¦ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰æˆ–è€…æ‰‹åŠ¨é‡ç½®è¯¥è¡Œæ—¶é—´
                row.onclick = () => {
                    if (item.time !== null) {
                        audio.currentTime = item.time;
                        audio.play();
                        isPlaying = true;
                        updatePlayButton();
                    }
                };

                const timeTag = document.createElement('span');
                timeTag.className = `font-mono text-sm mr-4 ${item.time !== null ? 'text-rose-400' : 'text-gray-600'}`;
                timeTag.innerText = item.displayTime;

                const textSpan = document.createElement('span');
                textSpan.className = `flex-1 text-lg ${item.time !== null ? 'text-gray-200' : 'text-gray-400'}`;
                textSpan.innerText = item.text;

                // æ’¤é”€æŒ‰é’® (ä»…å½“æœ‰æ—¶é—´æ—¶æ˜¾ç¤º)
                if (item.time !== null) {
                    const undoBtn = document.createElement('button');
                    undoBtn.innerHTML = 'â†º';
                    undoBtn.className = 'opacity-0 group-hover:opacity-100 text-gray-400 hover:text-white px-2';
                    undoBtn.title = 'é‡ç½®æ­¤è¡Œæ—¶é—´';
                    undoBtn.onclick = (e) => {
                        e.stopPropagation();
                        resetLine(index);
                    };
                    row.appendChild(undoBtn);
                }

                row.appendChild(timeTag);
                row.appendChild(textSpan);
                lyricsListEl.appendChild(row);
            });

            scrollToCurrent();
        }

        // --- æ ¸å¿ƒé€»è¾‘ï¼šæ‰“è½´ (Stamp) ---
        function stampCurrentLine() {
            if (currentLineIndex >= lyricsData.length) return;

            const currentTime = audio.currentTime;
            const formattedTime = formatTime(currentTime);

            // æ›´æ–°æ•°æ®
            lyricsData[currentLineIndex].time = currentTime;
            lyricsData[currentLineIndex].displayTime = formattedTime;

            // ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œ
            currentLineIndex++;
            
            // é‡æ–°æ¸²æŸ“åˆ—è¡¨ï¼ˆé«˜æ•ˆåšæ³•æ˜¯åªæ›´æ–°DOMï¼Œè¿™é‡Œä¸ºç®€å•ç›´æ¥é‡ç»˜æˆ–å±€éƒ¨æ›´æ–°ï¼‰
            renderLyricsList();
        }

        // é‡ç½®æŸä¸€è¡Œ
        function resetLine(index) {
            lyricsData[index].time = null;
            lyricsData[index].displayTime = '[--:--.--]';
            currentLineIndex = index; // å›åˆ°è¿™ä¸€è¡Œ
            renderLyricsList();
        }

        // --- æ’­æ”¾æ§åˆ¶ä¸é¢„è§ˆ ---
        
        function togglePlay() {
            if (audio.paused) {
                audio.play();
                isPlaying = true;
            } else {
                audio.pause();
                isPlaying = false;
            }
            updatePlayButton();
        }

        function rewind(seconds) {
            audio.currentTime = Math.max(0, audio.currentTime - seconds);
        }

        function updatePlayButton() {
            const icon = isPlaying ? 'â¸ æš‚åœ (ç©ºæ ¼)' : 'â–¶ æ’­æ”¾ (ç©ºæ ¼)';
            document.getElementById('playIcon').innerText = icon;
            // é«˜äº®æŒ‰é’®çŠ¶æ€
            if(isPlaying) {
                playPauseBtn.classList.add('bg-blue-600', 'border-blue-400');
                playPauseBtn.classList.remove('bg-gray-700');
            } else {
                playPauseBtn.classList.remove('bg-blue-600', 'border-blue-400');
                playPauseBtn.classList.add('bg-gray-700');
            }
        }

        // ç›‘å¬éŸ³é¢‘æ›´æ–° (ç”¨äºè¿›åº¦æ¡å’Œé¢„è§ˆé«˜äº®)
        audio.addEventListener('timeupdate', () => {
            const currentTime = audio.currentTime;
            const duration = audio.duration || 0;

            // 1. æ›´æ–°æ—¶é—´æ˜¾ç¤º
            document.getElementById('currentTimeDisplay').innerText = formatTime(currentTime);
            document.getElementById('durationDisplay').innerText = formatTime(duration);

            // 2. æ›´æ–°è¿›åº¦æ¡
            const percent = (currentTime / duration) * 100;
            document.getElementById('progressBar').style.width = `${percent}%`;

            // 3. é¢„è§ˆé€»è¾‘ï¼šé«˜äº®å½“å‰æ’­æ”¾åˆ°çš„æ­Œè¯è¡Œ
            // åªæœ‰å½“è¯¥è¡Œå·²ç»æ‰“è¿‡è½´ï¼ˆæœ‰æ—¶é—´ï¼‰æ‰å‚ä¸æ¯”å¯¹
            let activePreviewIndex = -1;
            for (let i = 0; i < lyricsData.length; i++) {
                if (lyricsData[i].time !== null && lyricsData[i].time <= currentTime + 0.2) { // 0.2s å®¹é”™
                    activePreviewIndex = i;
                }
            }

            // ç§»é™¤æ—§çš„é«˜äº®ï¼Œæ·»åŠ æ–°çš„
            document.querySelectorAll('.lyric-line').forEach(el => el.classList.remove('preview-active'));
            if (activePreviewIndex !== -1) {
                const activeEl = document.getElementById(`line-${activePreviewIndex}`);
                if (activeEl) activeEl.classList.add('preview-active');
            }
        });

        // è¿›åº¦æ¡ç‚¹å‡»è·³è½¬
        document.getElementById('progressBarContainer').addEventListener('click', (e) => {
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const width = rect.width;
            const duration = audio.duration;
            if (duration) {
                audio.currentTime = (x / width) * duration;
            }
        });

        // --- è¾…åŠ©å·¥å…· ---
        
        // æ ¼å¼åŒ–æ—¶é—´ [mm:ss.xx]
        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            const ms = Math.floor((seconds % 1) * 100);
            
            const minStr = min.toString().padStart(2, '0');
            const secStr = sec.toString().padStart(2, '0');
            const msStr = ms.toString().padStart(2, '0');
            
            return `[${minStr}:${secStr}.${msStr}]`;
        }

        // æ»šåŠ¨åˆ°å½“å‰ç¼–è¾‘è¡Œ
        function scrollToCurrent() {
            const el = document.getElementById(`line-${currentLineIndex}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // ä¸‹è½½æ–‡ä»¶
        function downloadLRC() {
            let content = '';
            // æ·»åŠ LRCå¤´ä¿¡æ¯ (å¯é€‰)
            content += "[ti:æœªçŸ¥æ ‡é¢˜]\n[ar:æœªçŸ¥è‰ºæœ¯å®¶]\n[al:Created by LRC Maker]\n";
            
            lyricsData.forEach(item => {
                if (item.time !== null) {
                    content += `${item.displayTime}${item.text}\n`;
                }
            });

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'lyrics.lrc';
            a.click();
            URL.revokeObjectURL(url);
        }

        function resetEditor() {
            if(confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿ")) {
                location.reload();
            }
        }

        // --- é”®ç›˜å¿«æ·é”® ---
        document.addEventListener('keydown', (e) => {
            // åªæœ‰å½“ä¸åœ¨è¾“å…¥æ¡†æ—¶æ‰è§¦å‘å¿«æ·é”®
            if (document.activeElement === rawLyricsEl) return;

            if (e.code === 'Space') {
                e.preventDefault(); // é˜²æ­¢é¡µé¢æ»šåŠ¨
                togglePlay();
            } else if (e.code === 'Enter') {
                e.preventDefault();
                stampBtn.click(); // è§¦å‘è§†è§‰åé¦ˆ
            }
        });

    </script>
</body>
</html>