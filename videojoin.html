<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web视频剪辑器 - 纯HTML版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* 自定义滚动条样式 */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #444;
        }

        .timeline-track {
            background-image: linear-gradient(90deg, #222 1px, transparent 1px);
            background-size: 50px 100%;
        }

        .segment-selected {
            border-color: #3b82f6 !important;
            background-color: rgba(59, 130, 246, 0.2) !important;
        }

        /* 导出弹窗动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-animate {
            animation: fadeIn 0.2s ease-out forwards;
        }
    </style>
</head>
<body class="bg-black text-gray-200 h-screen flex flex-col overflow-hidden font-sans">

    <!-- 顶部导航栏 -->
    <header class="h-12 border-b border-gray-800 flex items-center justify-between px-4 bg-[#1a1a1a] z-50">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center">
                <i data-lucide="film" class="text-white w-5 h-5"></i>
            </div>
            <span class="font-bold tracking-tight text-white">WEB剪映 HTML-PRO</span>
        </div>
        <div class="flex items-center gap-4">
            <button id="btnExport" class="text-sm bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded-full flex items-center gap-2 transition font-medium">
                <i data-lucide="download" class="w-4 h-4"></i> 导出视频
            </button>
        </div>
    </header>

    <!-- 中间区域 -->
    <main class="flex-1 flex overflow-hidden">
        <!-- 左侧媒体库 -->
        <aside class="w-72 border-r border-gray-800 flex flex-col bg-[#1a1a1a]">
            <div class="p-4 border-b border-gray-800">
                <label class="flex items-center justify-center gap-2 w-full bg-gray-800 hover:bg-gray-700 py-3 rounded-lg cursor-pointer border-2 border-dashed border-gray-600 transition">
                    <i data-lucide="plus-square" class="w-5 h-5"></i>
                    <span>导入素材</span>
                    <input type="file" id="fileInput" multiple accept="video/*" class="hidden">
                </label>
            </div>
            <div id="mediaLibrary" class="flex-1 overflow-y-auto p-3 grid grid-cols-2 gap-2 content-start">
                <!-- 媒体素材将通过JS动态插入 -->
            </div>
        </aside>

        <!-- 视频预览区 -->
        <section class="flex-1 bg-[#111] flex flex-col items-center justify-center relative p-8">
            <div class="w-full max-w-3xl aspect-video bg-black shadow-2xl relative rounded overflow-hidden">
                <video id="mainVideo" class="w-full h-full" playsinline muted></video>
                <!-- 隐藏的渲染画布，用于导出 -->
                <canvas id="exportCanvas" class="hidden"></canvas>
            </div>
            
            <!-- 预览控制 -->
            <div class="mt-6 flex items-center gap-6">
                <button id="btnReset" class="hover:text-blue-500 transition"><i data-lucide="skip-back" class="w-6 h-6"></i></button>
                <button id="btnPlayPause" class="w-12 h-12 bg-white text-black rounded-full flex items-center justify-center hover:scale-105 transition">
                    <i data-lucide="play" id="playIcon" class="w-7 h-7 fill-black"></i>
                </button>
                <div class="text-lg font-mono w-32 text-center">
                    <span id="currentTimeDisplay">0.0</span> 
                    <span class="text-gray-600 text-sm">/ <span id="totalDurationDisplay">0.0</span></span>
                </div>
            </div>
        </section>
    </main>

    <!-- 底部时间轴 -->
    <footer class="h-72 bg-[#1a1a1a] border-t border-gray-800 flex flex-col">
        <!-- 工具栏 -->
        <div class="h-10 border-b border-gray-800 flex items-center px-4 gap-6">
            <button id="btnSplit" class="flex items-center gap-1.5 text-xs hover:text-blue-500 transition disabled:opacity-50">
                <i data-lucide="scissors" class="w-4 h-4"></i> 分割
            </button>
            <button id="btnDelete" class="flex items-center gap-1.5 text-xs hover:text-red-500 transition disabled:opacity-50">
                <i data-lucide="trash-2" class="w-4 h-4"></i> 删除
            </button>
            <div class="flex-1"></div>
            <div class="flex items-center gap-2">
                <span class="text-[10px] text-gray-500">缩放</span>
                <input type="range" id="zoomRange" min="20" max="100" value="50" class="w-24 h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer">
            </div>
        </div>

        <!-- 时间轴主体 -->
        <div id="timelineContainer" class="flex-1 overflow-x-auto overflow-y-hidden relative bg-[#141414] select-none">
            <!-- 时间标尺 -->
            <div id="timelineRuler" class="h-6 w-[5000px] border-b border-gray-800 relative timeline-track">
                <!-- 刻度JS生成 -->
            </div>

            <!-- 视频轨道 -->
            <div id="videoTrack" class="relative h-24 mt-4 px-1 flex">
                <!-- 片段将在此生成 -->
            </div>

            <!-- 播放头 -->
            <div id="playhead" class="absolute top-0 bottom-0 w-px bg-white z-50 pointer-events-none shadow-[0_0_8px_rgba(255,255,255,0.5)]">
                <div class="w-3 h-3 bg-white absolute -left-1.5 top-0 rotate-45"></div>
            </div>
        </div>
    </footer>

    <!-- 导出进度弹窗 -->
    <div id="exportModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-[#1a1a1a] border border-gray-700 rounded-2xl p-8 w-96 shadow-2xl modal-animate text-center">
            <div id="exportStatusIcon" class="mb-4 flex justify-center text-blue-500 animate-spin">
                <i data-lucide="loader-2" class="w-12 h-12"></i>
            </div>
            <h3 id="exportTitle" class="text-xl font-bold mb-2">正在导出视频...</h3>
            <p id="exportSubtitle" class="text-gray-400 text-sm mb-6">正在实时压制 WebM 格式视频</p>
            
            <div class="w-full bg-gray-800 h-2 rounded-full overflow-hidden mb-4">
                <div id="exportProgressBar" class="bg-blue-600 h-full w-0 transition-all duration-300"></div>
            </div>
            
            <div id="exportProgressText" class="text-sm font-mono text-blue-400 mb-4">0%</div>

            <button id="btnCloseModal" class="hidden w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 rounded-lg transition shadow-lg">完成并关闭</button>
        </div>
    </div>

    <script>
        // 状态管理
        let state = {
            mediaLibrary: [],
            segments: [],
            currentTime: 0,
            isPlaying: false,
            isExporting: false,
            selectedSegmentId: null,
            zoom: 50,
            totalDuration: 0
        };

        // DOM 元素
        const mediaLibraryEl = document.getElementById('mediaLibrary');
        const videoTrackEl = document.getElementById('videoTrack');
        const mainVideo = document.getElementById('mainVideo');
        const exportCanvas = document.getElementById('exportCanvas');
        const exportCtx = exportCanvas.getContext('2d');
        const playhead = document.getElementById('playhead');
        const timelineContainer = document.getElementById('timelineContainer');
        const currentTimeDisplay = document.getElementById('currentTimeDisplay');
        const totalDurationDisplay = document.getElementById('totalDurationDisplay');
        const playIcon = document.getElementById('playIcon');
        
        const exportModal = document.getElementById('exportModal');
        const exportProgressBar = document.getElementById('exportProgressBar');
        const exportProgressText = document.getElementById('exportProgressText');
        const exportTitle = document.getElementById('exportTitle');
        const exportSubtitle = document.getElementById('exportSubtitle');
        const exportStatusIcon = document.getElementById('exportStatusIcon');
        const btnCloseModal = document.getElementById('btnCloseModal');

        lucide.createIcons();

        // 媒体库导入
        document.getElementById('fileInput').addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                const url = URL.createObjectURL(file);
                const video = document.createElement('video');
                video.src = url;
                video.onloadedmetadata = () => {
                    const item = {
                        id: 'm-' + Math.random().toString(36).substr(2, 9),
                        url,
                        name: file.name,
                        duration: video.duration
                    };
                    state.mediaLibrary.push(item);
                    renderMediaLibrary();
                };
            });
        });

        function renderMediaLibrary() {
            mediaLibraryEl.innerHTML = state.mediaLibrary.map(item => `
                <div class="group relative aspect-video bg-gray-900 rounded overflow-hidden border border-transparent hover:border-blue-500 cursor-pointer">
                    <video src="${item.url}" class="w-full h-full object-cover pointer-events-none"></video>
                    <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center transition">
                        <button onclick="addToTimeline('${item.id}')" class="p-1 bg-blue-600 rounded-full text-white">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="absolute bottom-1 right-1 text-[10px] bg-black/60 px-1 rounded">
                        ${item.duration.toFixed(1)}s
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        window.addToTimeline = (mediaId) => {
            const media = state.mediaLibrary.find(m => m.id === mediaId);
            const newSegment = {
                id: 's-' + Math.random().toString(36).substr(2, 9),
                mediaId: media.id,
                url: media.url,
                name: media.name,
                startTime: 0,
                endTime: media.duration
            };
            state.segments.push(newSegment);
            updateTimeline();
        };

        function updateTimeline() {
            state.totalDuration = state.segments.reduce((acc, seg) => acc + (seg.endTime - seg.startTime), 0);
            totalDurationDisplay.innerText = state.totalDuration.toFixed(1);

            videoTrackEl.innerHTML = state.segments.map(seg => {
                const width = (seg.endTime - seg.startTime) * (state.zoom / 2);
                const isSelected = state.selectedSegmentId === seg.id;
                return `
                    <div onclick="selectSegment('${seg.id}')" 
                         class="relative h-16 rounded overflow-hidden flex-shrink-0 cursor-pointer border-2 transition-all ${isSelected ? 'segment-selected' : 'border-gray-700 bg-gray-800'}"
                         style="width: ${width}px">
                        <div class="absolute inset-0 flex items-center px-2 overflow-hidden whitespace-nowrap text-[10px] text-gray-300 z-10">
                            ${seg.name}
                        </div>
                        <div class="absolute inset-0 opacity-20 bg-gradient-to-r from-gray-600 to-transparent"></div>
                    </div>
                `;
            }).join('');

            syncVideo();
        }

        window.selectSegment = (id) => {
            state.selectedSegmentId = id;
            updateTimeline();
        };

        // 分割与删除
        document.getElementById('btnSplit').addEventListener('click', () => {
            let accumulated = 0;
            let targetIdx = -1;
            let localTime = 0;

            for(let i=0; i<state.segments.length; i++) {
                const duration = state.segments[i].endTime - state.segments[i].startTime;
                if (state.currentTime >= accumulated && state.currentTime < accumulated + duration) {
                    targetIdx = i;
                    localTime = state.currentTime - accumulated + state.segments[i].startTime;
                    break;
                }
                accumulated += duration;
            }

            if (targetIdx !== -1) {
                const original = state.segments[targetIdx];
                const part1 = { ...original, id: 's-'+Math.random(), endTime: localTime };
                const part2 = { ...original, id: 's-'+Math.random(), startTime: localTime };
                state.segments.splice(targetIdx, 1, part1, part2);
                updateTimeline();
            }
        });

        document.getElementById('btnDelete').addEventListener('click', () => {
            if (state.selectedSegmentId) {
                state.segments = state.segments.filter(s => s.id !== state.selectedSegmentId);
                state.selectedSegmentId = null;
                updateTimeline();
            }
        });

        // 核心功能：导出真正的视频
        document.getElementById('btnExport').addEventListener('click', async () => {
            if (state.segments.length === 0) {
                alert('时间轴上没有素材！');
                return;
            }

            // 1. 初始化弹窗与状态
            state.isExporting = true;
            state.isPlaying = false;
            state.currentTime = 0;
            exportModal.classList.remove('hidden');
            exportTitle.innerText = '正在合成视频...';
            exportSubtitle.innerText = '正在按 WebM 格式进行流压制';
            btnCloseModal.classList.add('hidden');
            
            // 2. 准备画布与录制器
            exportCanvas.width = 1280;
            exportCanvas.height = 720;
            const stream = exportCanvas.captureStream(30); // 30 FPS
            const recorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp8' });
            const chunks = [];

            recorder.ondataavailable = (e) => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `WebEditor_${Date.now()}.webm`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                // UI 更新
                exportTitle.innerText = '导出成功！';
                exportSubtitle.innerText = '视频已保存至你的下载文件夹。';
                exportStatusIcon.classList.remove('animate-spin', 'text-blue-500');
                exportStatusIcon.classList.add('text-green-500');
                exportStatusIcon.innerHTML = '<i data-lucide="check-circle" class="w-12 h-12"></i>';
                btnCloseModal.classList.remove('hidden');
                lucide.createIcons();
                state.isExporting = false;
            };

            recorder.start();

            // 3. 开始“压制”循环 (快进式渲染)
            const exportLoop = async () => {
                if (state.currentTime >= state.totalDuration) {
                    recorder.stop();
                    return;
                }

                syncVideo();
                // 将视频当前帧画入 Canvas
                exportCtx.drawImage(mainVideo, 0, 0, exportCanvas.width, exportCanvas.height);
                
                // 模拟导出进度：每次步进 0.05s (可根据需要调整速度)
                state.currentTime += 0.05; 
                updatePlayheadPosition();

                const progress = (state.currentTime / state.totalDuration) * 100;
                exportProgressBar.style.width = progress + '%';
                exportProgressText.innerText = Math.min(100, Math.floor(progress)) + '%';

                requestAnimationFrame(exportLoop);
            };

            exportLoop();
        });

        btnCloseModal.addEventListener('click', () => exportModal.classList.add('hidden'));

        // 播放与同步逻辑
        let lastTimestamp = 0;
        function step(timestamp) {
            if (!lastTimestamp) lastTimestamp = timestamp;
            const dt = (timestamp - lastTimestamp) / 1000;
            lastTimestamp = timestamp;

            if (state.isPlaying && !state.isExporting) {
                state.currentTime += dt;
                if (state.currentTime >= state.totalDuration) {
                    state.currentTime = 0;
                    state.isPlaying = false;
                    playIcon.setAttribute('data-lucide', 'play');
                    lucide.createIcons();
                }
                updatePlayheadPosition();
                syncVideo();
            }
            requestAnimationFrame(step);
        }
        requestAnimationFrame(step);

        function syncVideo() {
            let accumulated = 0;
            let currentSeg = null;
            let localTime = 0;

            for(const seg of state.segments) {
                const duration = seg.endTime - seg.startTime;
                if (state.currentTime >= accumulated && state.currentTime <= accumulated + duration) {
                    currentSeg = seg;
                    localTime = state.currentTime - accumulated + seg.startTime;
                    break;
                }
                accumulated += duration;
            }

            if (currentSeg) {
                if (mainVideo.src !== currentSeg.url) {
                    mainVideo.src = currentSeg.url;
                }
                // 导出时需要非常精准的同步
                if (state.isExporting) {
                    mainVideo.currentTime = localTime;
                } else if (Math.abs(mainVideo.currentTime - localTime) > 0.2) {
                    mainVideo.currentTime = localTime;
                }
                currentTimeDisplay.innerText = state.currentTime.toFixed(1);
            }
        }

        function updatePlayheadPosition() {
            const x = state.currentTime * (state.zoom / 2);
            playhead.style.left = x + 'px';
        }

        document.getElementById('btnPlayPause').addEventListener('click', () => {
            state.isPlaying = !state.isPlaying;
            playIcon.setAttribute('data-lucide', state.isPlaying ? 'pause' : 'play');
            lucide.createIcons();
            if (state.isPlaying) mainVideo.play(); else mainVideo.pause();
        });

        document.getElementById('btnReset').addEventListener('click', () => {
            state.currentTime = 0;
            updatePlayheadPosition();
            syncVideo();
        });

        document.getElementById('zoomRange').addEventListener('input', (e) => {
            state.zoom = e.target.value;
            updateTimeline();
            updatePlayheadPosition();
        });

        timelineContainer.addEventListener('mousedown', (e) => {
            if (state.isExporting) return;
            const rect = timelineContainer.getBoundingClientRect();
            const clickX = e.clientX - rect.left + timelineContainer.scrollLeft;
            state.currentTime = Math.max(0, Math.min(clickX / (state.zoom / 2), state.totalDuration));
            updatePlayheadPosition();
            syncVideo();
        });

        updateTimeline();
    </script>
</body>
</html>