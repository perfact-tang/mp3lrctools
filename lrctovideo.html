<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ­Œè¯è§†é¢‘ç”Ÿæˆå™¨ (Proç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä¿æŒåŸæœ‰æ ·å¼ */
        #canvas-container {
            display: flex;
            justify-content: center;
            align-items: center;
            background-image:
                linear-gradient(45deg, #1f2937 25%, transparent 25%),
                linear-gradient(-45deg, #1f2937 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #1f2937 75%),
                linear-gradient(-45deg, transparent 75%, #1f2937 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            overflow: hidden;
            box-shadow: inset 0 0 20px #000;
        }
        
        canvas {
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        
        /* èŒƒå›´æ»‘å—æ ·å¼ä¼˜åŒ– */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            margin-top: -6px; 
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #4b5563;
            border-radius: 2px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-screen flex flex-col overflow-hidden font-sans">

    <!-- é¡¶éƒ¨ -->
    <header class="bg-gray-800 border-b border-gray-700 p-3 flex justify-between items-center shrink-0 z-10">
        <div class="flex items-center gap-2">
            <span class="text-2xl">ğŸ¬</span>
            <h1 class="text-lg font-bold text-white">LRC æ­Œè¯è§†é¢‘ç”Ÿæˆå™¨ <span class="text-xs bg-blue-600 px-2 py-0.5 rounded ml-2">Pro</span></h1>
        </div>
        <div class="text-xs text-gray-400">
            ä¼˜åŒ–æç¤ºï¼šå½•åˆ¶æœŸé—´è¯·å‹¿åˆ‡æ¢æ ‡ç­¾é¡µ
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        <!-- å·¦ä¾§ï¼šè®¾ç½®é¢æ¿ -->
        <aside class="w-80 min-w-[320px] bg-gray-800 border-r border-gray-700 flex flex-col overflow-y-auto">
            
            <div class="p-4 space-y-6">
                <!-- 1. æ–‡ä»¶ä¸Šä¼  -->
                <div class="space-y-3 p-3 bg-gray-700 rounded-lg">
                    <h2 class="text-sm font-bold text-blue-300 uppercase">1. ç´ æä¸Šä¼ </h2>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">MP3 éŸ³é¢‘</label>
                        <input type="file" id="audioInput" accept="audio/*" class="w-full text-xs text-gray-300 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:bg-blue-600 file:text-white hover:file:bg-blue-500 cursor-pointer">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">LRC æ­Œè¯æ–‡ä»¶</label>
                        <input type="file" id="lrcInput" accept=".lrc,.txt" class="w-full text-xs text-gray-300 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:bg-purple-600 file:text-white hover:file:bg-purple-500 cursor-pointer">
                    </div>
                </div>

                <!-- 2. è§†é¢‘è®¾ç½® -->
                <div class="space-y-3 p-3 bg-gray-700 rounded-lg">
                    <h2 class="text-sm font-bold text-green-300 uppercase">2. è§†é¢‘å°ºå¯¸</h2>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="setRatio(1080, 1920)" class="ratio-btn bg-gray-600 hover:bg-gray-500 text-xs py-2 rounded text-center active:bg-green-600">9:16 (æŠ–éŸ³)</button>
                        <button onclick="setRatio(1080, 1080)" class="ratio-btn bg-gray-600 hover:bg-gray-500 text-xs py-2 rounded text-center active:bg-green-600">1:1 (INS)</button>
                        <button onclick="setRatio(1920, 1080)" class="ratio-btn bg-gray-600 hover:bg-gray-500 text-xs py-2 rounded text-center active:bg-green-600">16:9 (æ¨ªå±)</button>
                        <button onclick="setRatio(1440, 1080)" class="ratio-btn bg-gray-600 hover:bg-gray-500 text-xs py-2 rounded text-center active:bg-green-600">4:3 (å¤å¤)</button>
                    </div>
                </div>

                <!-- 3. å¤–è§‚ä¸ç‰¹æ•ˆ -->
                <div class="space-y-3 p-3 bg-gray-700 rounded-lg">
                    <h2 class="text-sm font-bold text-yellow-300 uppercase">3. æ ·å¼ä¸ç‰¹æ•ˆ</h2>
                    
                    <!-- è§†è§‰ç‰¹æ•ˆé€‰æ‹© -->
                    <div class="mb-3">
                        <label class="block text-xs text-gray-400 mb-1">è§†è§‰ç‰¹æ•ˆ</label>
                        <select id="effectType" class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-sm text-yellow-400 font-bold">
                            <option value="normal">ç»å…¸å¹³æ»‘æ»šåŠ¨ (Smooth)</option>
                            <option value="neon">éœ“è™¹å‘å…‰ (Neon Glow)</option>
                            <option value="blur">èšç„¦æ¨¡ç³Š (Focus Blur)</option>
                            <option value="pulse">åŠ¨æ„Ÿè„‰å†² (Pulse)</option>
                        </select>
                    </div>

                    <!-- å­—ä½“å¤§å° -->
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs text-gray-400">æ™®é€šå­—å·</label>
                            <input type="number" id="fontSizeNormal" value="30" class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400">é«˜äº®å­—å·</label>
                            <input type="number" id="fontSizeActive" value="60" class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-sm font-bold text-yellow-500">
                        </div>
                    </div>

                    <!-- è¡Œè·æ§åˆ¶ -->
                    <div>
                        <div class="flex justify-between">
                            <label class="block text-xs text-gray-400">è¡Œè· (é—´éš™)</label>
                            <span id="lineHeightVal" class="text-xs text-gray-400">1.8x</span>
                        </div>
                        <input type="range" id="lineHeightMult" min="1.0" max="3.0" step="0.1" value="1.8" class="w-full mt-1">
                    </div>

                    <!-- é¢œè‰² -->
                    <div class="grid grid-cols-3 gap-2 mt-2">
                        <div>
                            <label class="block text-[10px] text-gray-400 text-center">æ™®é€šè‰²</label>
                            <input type="color" id="colorText" value="#ffffff" class="w-full h-6 bg-transparent cursor-pointer rounded">
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-400 text-center">é«˜äº®è‰²</label>
                            <input type="color" id="colorActive" value="#facc15" class="w-full h-6 bg-transparent cursor-pointer rounded">
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-400 text-center">èƒŒæ™¯è‰²</label>
                            <input type="color" id="colorBg" value="#000000" class="w-full h-6 bg-transparent cursor-pointer rounded">
                        </div>
                    </div>

                    <!-- å­—ä½“ -->
                    <div class="mt-2">
                        <label class="block text-xs text-gray-400">å­—ä½“</label>
                        <select id="fontFamily" class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-sm">
                            <option value="'Microsoft YaHei', sans-serif" selected>å¾®è½¯é›…é»‘ (Bold)</option>
                            <option value="Arial, sans-serif">Arial</option>
                            <option value="'PingFang SC', sans-serif">è‹¹æ–¹</option>
                            <option value="'Times New Roman', serif">å®‹ä½“/è¡¬çº¿</option>
                            <option value="cursive">æ‰‹å†™é£æ ¼</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- æ§åˆ¶æŒ‰é’®åŒº -->
            <div class="mt-auto p-4 border-t border-gray-700 bg-gray-800 sticky bottom-0">
                <div id="statusText" class="text-center text-xs mb-2 text-gray-400">å‡†å¤‡å°±ç»ª</div>
                
                <div class="grid grid-cols-1 gap-2">
                    <button id="previewBtn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded transition flex justify-center items-center gap-2">
                        <span>â–¶</span> ä»…æ’­æ”¾/é¢„è§ˆ
                    </button>
                    
                    <button id="recordBtn" class="bg-rose-600 hover:bg-rose-500 text-white font-bold py-3 px-4 rounded shadow-lg transition flex justify-center items-center gap-2 border-b-4 border-rose-800 active:border-b-0 active:translate-y-1">
                        <span class="w-3 h-3 bg-white rounded-full animate-pulse hidden" id="recordDot"></span>
                        <span id="recordBtnText">ğŸ¥ å¼€å§‹å½•åˆ¶è§†é¢‘</span>
                    </button>
                    
                    <a id="downloadLink" class="hidden bg-green-600 hover:bg-green-500 text-center text-white font-bold py-2 px-4 rounded transition">
                        â¬‡ï¸ ä¸‹è½½è§†é¢‘
                    </a>
                </div>
            </div>
        </aside>

        <!-- å³ä¾§ï¼šç”»å¸ƒåŒºåŸŸ -->
        <section id="canvas-container" class="flex-1 p-8 relative">
            <canvas id="videoCanvas"></canvas>
            <audio id="audioElement" crossorigin="anonymous"></audio>
        </section>
    </main>

    <script>
        // --- æ ¸å¿ƒå˜é‡ ---
        const canvas = document.getElementById('videoCanvas');
        const ctx = canvas.getContext('2d');
        const audio = document.getElementById('audioElement');
        
        let lyrics = []; 
        let animationId;
        
        // å½•åˆ¶ç›¸å…³
        let mediaRecorder;
        let recordedChunks = [];
        let audioContext;
        let audioSource;
        let dest;
        
        // æ¸²æŸ“çŠ¶æ€
        let smoothScrollIndex = 0; // ç”¨äºå¹³æ»‘æ»šåŠ¨çš„è™šæ‹Ÿç´¢å¼•
        
        // é…ç½®çŠ¶æ€
        const config = {
            width: 1080,
            height: 1920,
            fontNormal: 30,
            fontActive: 60,
            lineHeightMult: 1.8,
            colorText: '#ffffff',
            colorActive: '#facc15',
            colorBg: '#000000',
            fontFamily: "'Microsoft YaHei', sans-serif",
            effect: 'normal' // normal, neon, blur, pulse
        };

        // --- åˆå§‹åŒ– ---
        function initCanvas() {
            canvas.width = config.width;
            canvas.height = config.height;
            ctx.fillStyle = config.colorBg;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const container = document.getElementById('canvas-container');
            const scale = Math.min(
                (container.clientWidth - 40) / config.width,
                (container.clientHeight - 40) / config.height
            );
            canvas.style.width = `${config.width * scale}px`;
            canvas.style.height = `${config.height * scale}px`;
        }

        window.addEventListener('resize', initCanvas);
        initCanvas();

        // --- äº‹ä»¶ç›‘å¬ ---

        // UI ç»‘å®š
        const bind = (id, key, parser = v => v, callback = null) => {
            document.getElementById(id).addEventListener('input', (e) => {
                config[key] = parser(e.target.value);
                if (callback) callback(e.target.value);
                if (audio.paused) drawFrame();
            });
        };

        bind('fontSizeNormal', 'fontNormal', parseInt);
        bind('fontSizeActive', 'fontActive', parseInt);
        bind('lineHeightMult', 'lineHeightMult', parseFloat, (v) => document.getElementById('lineHeightVal').innerText = v + 'x');
        bind('colorText', 'colorText');
        bind('colorBg', 'colorBg');
        bind('colorActive', 'colorActive');
        
        document.getElementById('fontFamily').addEventListener('change', (e) => { config.fontFamily = e.target.value; if(audio.paused) drawFrame(); });
        document.getElementById('effectType').addEventListener('change', (e) => { config.effect = e.target.value; if(audio.paused) drawFrame(); });

        window.setRatio = (w, h) => {
            config.width = w;
            config.height = h;
            initCanvas();
            if(audio.paused) drawFrame();
        }

        // æ–‡ä»¶ç›‘å¬
        document.getElementById('audioInput').addEventListener('change', (e) => {
            if(e.target.files[0]) audio.src = URL.createObjectURL(e.target.files[0]);
        });

        document.getElementById('lrcInput').addEventListener('change', (e) => {
            if(e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (ev) => parseLRC(ev.target.result);
                reader.readAsText(e.target.files[0]);
            }
        });

        document.getElementById('previewBtn').addEventListener('click', togglePreview);
        document.getElementById('recordBtn').addEventListener('click', toggleRecording);

        // --- é€»è¾‘åŠŸèƒ½ ---

        function parseLRC(lrcText) {
            lyrics = [];
            const lines = lrcText.split('\n');
            const timeReg = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/;
            
            lines.forEach(line => {
                const match = timeReg.exec(line);
                if (match) {
                    const min = parseInt(match[1]);
                    const sec = parseInt(match[2]);
                    const ms = parseInt(match[3].padEnd(3, '0'));
                    const time = min * 60 + sec + ms / 1000;
                    const text = line.replace(timeReg, '').trim();
                    if(text) lyrics.push({ time, text });
                }
            });
            lyrics.sort((a, b) => a.time - b.time);
            document.getElementById('statusText').innerText = `å·²åŠ è½½ ${lyrics.length} è¡Œæ­Œè¯`;
            drawFrame();
        }

        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioSource = audioContext.createMediaElementSource(audio);
                dest = audioContext.createMediaStreamDestination();
                audioSource.connect(dest);
                audioSource.connect(audioContext.destination);
            } else if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        // --- æ ¸å¿ƒæ¸²æŸ“å¼•æ“ ---

        function drawFrame() {
            // 1. æ¸…é™¤ç”»å¸ƒ
            ctx.fillStyle = config.colorBg;
            ctx.fillRect(0, 0, config.width, config.height);

            if (lyrics.length === 0) {
                // ç©ºçŠ¶æ€æç¤º
                ctx.fillStyle = "#555";
                ctx.font = `30px ${config.fontFamily}`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText("è¯·ä¸Šä¼ ç´ æ...", config.width/2, config.height/2);
                return;
            }

            const currentTime = audio.currentTime;
            
            // 2. æŸ¥æ‰¾å½“å‰æ­Œè¯ç´¢å¼•
            let activeIndex = -1;
            for (let i = 0; i < lyrics.length; i++) {
                if (currentTime >= lyrics[i].time) {
                    activeIndex = i;
                } else {
                    break;
                }
            }

            // 3. å¹³æ»‘æ»šåŠ¨ç®—æ³•
            // æˆ‘ä»¬ä¸å¸Œæœ› smoothScrollIndex ç¬é—´è·³åˆ° activeIndexï¼Œè€Œæ˜¯å¹³æ»‘è¿‡æ¸¡
            // ä½¿ç”¨ Lerp (Linear Interpolation) 
            let targetIndex = activeIndex < 0 ? 0 : activeIndex;
            
            // æ»šåŠ¨é€Ÿåº¦ç³»æ•° (0.1 è¾ƒæ…¢å¹³æ»‘ï¼Œ0.2 è¾ƒå¿«)
            const lerpSpeed = 0.1;
            smoothScrollIndex += (targetIndex - smoothScrollIndex) * lerpSpeed;

            // 4. è®¡ç®—å¸ƒå±€å‚æ•°
            const centerY = config.height / 2;
            const lineHeight = config.fontNormal * config.lineHeightMult; // ä½¿ç”¨è®¾å®šçš„è¡Œè·
            
            // 5. è‡ªåŠ¨é€‚åº”è¡Œæ•°ï¼šæ ¹æ®å±å¹•é«˜åº¦ï¼Œè®¡ç®—ä¸Šä¸‹å„èƒ½ç”»å¤šå°‘è¡Œ
            // é¢„ç•™ä¸­é—´é«˜äº®åŒºåŸŸçš„ç©ºé—´ (å‡è®¾é«˜äº®è¡Œå¤§æ¦‚å  2-3 å€æ™®é€šè¡Œé«˜)
            const availableHalfHeight = (config.height / 2) - (config.fontActive); 
            const visibleLinesHalf = Math.ceil(availableHalfHeight / lineHeight) + 2; // å¤šç”»2è¡Œé˜²æ­¢è¾¹ç¼˜çªç„¶æ¶ˆå¤±

            // 6. ç»˜åˆ¶å¾ªç¯
            // æˆ‘ä»¬ä» smoothScrollIndex ä¸Šä¸‹å„å»¶ä¼¸ visibleLinesHalf è¡Œè¿›è¡Œç»˜åˆ¶
            const startRenderIndex = Math.max(0, Math.floor(smoothScrollIndex - visibleLinesHalf));
            const endRenderIndex = Math.min(lyrics.length - 1, Math.floor(smoothScrollIndex + visibleLinesHalf));

            for (let i = startRenderIndex; i <= endRenderIndex; i++) {
                const item = lyrics[i];
                // è®¡ç®—è¯¥è¡Œç›¸å¯¹äºâ€œå½“å‰ç„¦ç‚¹ä½ç½®â€çš„åç§»é‡ (float)
                const offset = i - smoothScrollIndex; 
                
                // æ ¹æ® offset è®¡ç®— Y åæ ‡
                // å½“ offset ä¸º 0 æ—¶ï¼Œy = centerY
                // å½“ offset ä¸º 1 æ—¶ï¼Œy = centerY + lineHeight
                // è¿™é‡Œçš„ lineHeight æ˜¯åŸºç¡€è·ç¦»ï¼Œæˆ‘ä»¬å¯ä»¥è®©é è¿‘ä¸­å¿ƒçš„è·ç¦»æ‹‰å¤§ä¸€ç‚¹
                let y = centerY + (offset * lineHeight);

                // çŠ¶æ€åˆ¤å®š
                const isActive = (i === activeIndex);
                
                // --- ç‰¹æ•ˆé€»è¾‘åº”ç”¨ ---
                ctx.save(); // ä¿å­˜çŠ¶æ€ï¼Œé˜²æ­¢ç‰¹æ•ˆæ±¡æŸ“å…¶ä»–è¡Œ

                // A. å­—ä½“å¤§å°è¿‡æ¸¡
                // ç¦»ä¸­å¿ƒè¶Šè¿‘ï¼Œå­—ä½“è¶Šå¤§ã€‚å¦‚æœæ˜¯å½“å‰è¡Œï¼Œç›´æ¥ä½¿ç”¨ fontActive
                // è¿™é‡Œçš„ transitionFactor æ˜¯ 0~1ï¼Œ0è¡¨ç¤ºå®Œå…¨åœ¨ä¸­å¿ƒ
                let size = config.fontNormal;
                let color = config.colorText;
                let alpha = 1.0;

                if (isActive) {
                    size = config.fontActive;
                    color = config.colorActive;
                    
                    // ç‰¹æ•ˆï¼šåŠ¨æ„Ÿè„‰å†² (Pulse)
                    if (config.effect === 'pulse') {
                        // åˆ©ç”¨æ—¶é—´ç”Ÿæˆç®€å•çš„æ­£å¼¦æ³¢ç¼©æ”¾
                        const pulseScale = 1 + Math.sin(Date.now() / 100) * 0.05;
                        size *= pulseScale;
                    }
                } else {
                    // æ¸éšæ•ˆæœï¼šç¦»ä¸­å¿ƒè¶Šè¿œé€æ˜åº¦è¶Šä½
                    const dist = Math.abs(offset);
                    alpha = Math.max(0.1, 1 - (dist / visibleLinesHalf));
                    // ç¨å¾®å˜å°ä¸€ç‚¹
                    size = config.fontNormal * 0.9;
                }

                // ç‰¹æ•ˆï¼šéœ“è™¹å‘å…‰ (Neon)
                if (config.effect === 'neon' && isActive) {
                    ctx.shadowBlur = 30;
                    ctx.shadowColor = config.colorActive;
                }

                // ç‰¹æ•ˆï¼šèšç„¦æ¨¡ç³Š (Blur)
                if (config.effect === 'blur' && !isActive) {
                    // ç¦»ä¸­å¿ƒè¶Šè¿œè¶Šæ¨¡ç³Š
                    const blurAmount = Math.min(10, Math.abs(offset) * 2);
                    ctx.filter = `blur(${blurAmount}px)`;
                    alpha *= 0.6; // æ¨¡ç³Šæ¨¡å¼ä¸‹èƒŒæ™¯æ›´æš—
                }

                // ç»˜åˆ¶å±æ€§è®¾ç½®
                ctx.font = `bold ${size}px ${config.fontFamily}`;
                ctx.fillStyle = isActive ? color : hexToRgba(color, alpha);
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                // è‡ªåŠ¨æ¢è¡Œç»˜åˆ¶
                // å®½åº¦é™åˆ¶ï¼šå·¦å³å„ç•™ 10% è¾¹è·
                const maxW = config.width * 0.8;
                // è®¡ç®—è¯¥è¡Œçš„å®é™…é«˜åº¦å ç”¨ï¼ˆå¦‚æœæœ‰æ¢è¡Œï¼Œéœ€è¦è°ƒæ•´åç»­è¡Œçš„ä½ç½®å—ï¼Ÿè¿™é‡Œä¸ºäº†æµåŠ¨ç®€å•ï¼Œæš‚æ—¶å‡è®¾æ¯è¡Œé«˜åº¦ä¸€è‡´ï¼Œæˆ–è€…åŸºäºä¸­å¿ƒè‡ªåŠ¨æ•£å¼€ï¼‰
                // ä¼˜åŒ–ï¼šä¸ºäº†é˜²æ­¢æ–‡å­—é‡å ï¼Œæˆ‘ä»¬å¯ä»¥åŠ¨æ€è®¡ç®— Yã€‚ä½†å¹³æ»‘æ»šåŠ¨ä¸­åŠ¨æ€ Y æ¯”è¾ƒå¤æ‚ã€‚
                // ç®€å•çš„æ–¹æ¡ˆï¼šè¡Œè·è®¾å¤§ä¸€ç‚¹ï¼Œä¸”æ¢è¡Œæ–‡å­—å‚ç›´å±…ä¸­äºé‚£ä¸ª Y ç‚¹ã€‚
                
                wrapText(ctx, item.text, config.width / 2, y, maxW, size * 1.4);

                ctx.restore(); // æ¢å¤çŠ¶æ€
            }

            if (!audio.paused) {
                animationId = requestAnimationFrame(drawFrame);
            }
        }

        // å·¥å…·ï¼šè‡ªåŠ¨æ¢è¡Œ
        function wrapText(context, text, x, y, maxWidth, lineHeight) {
            const words = text.split(''); 
            let line = '';
            let lines = [];

            for(let n = 0; n < words.length; n++) {
                let testLine = line + words[n];
                let metrics = context.measureText(testLine);
                let testWidth = metrics.width;
                if (testWidth > maxWidth && n > 0) {
                    lines.push(line);
                    line = words[n];
                } else {
                    line = testLine;
                }
            }
            lines.push(line);

            // å‚ç›´å±…ä¸­ç»˜åˆ¶å—
            const totalHeight = lines.length * lineHeight;
            // ä¿®æ­£ Y èµ·ç‚¹ï¼Œä½¿æ•´ä¸ªæ–‡æœ¬å—çš„ä¸­å¿ƒä½äº y
            let startY = y - ((lines.length - 1) * lineHeight) / 2;

            for (let k = 0; k < lines.length; k++) {
                context.fillText(lines[k], x, startY + (k * lineHeight));
            }
        }

        function hexToRgba(hex, alpha) {
            let r = parseInt(hex.slice(1, 3), 16);
            let g = parseInt(hex.slice(3, 5), 16);
            let b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // --- æ’­æ”¾ä¸å½•åˆ¶æ§åˆ¶ (ä¿æŒä¸å˜) ---

        function togglePreview() {
            if (audio.src === "") return alert("è¯·å…ˆä¸Šä¼ éŸ³é¢‘æ–‡ä»¶");
            if (lyrics.length === 0) return alert("è¯·å…ˆä¸Šä¼ LRCæ–‡ä»¶");

            if (audio.paused) {
                audio.play();
                drawFrame();
                document.getElementById('previewBtn').innerHTML = "â¸ æš‚åœé¢„è§ˆ";
            } else {
                audio.pause();
                cancelAnimationFrame(animationId);
                document.getElementById('previewBtn').innerHTML = "â–¶ ä»…æ’­æ”¾/é¢„è§ˆ";
            }
        }

        function toggleRecording() {
            if (audio.src === "") return alert("è¯·å…ˆä¸Šä¼ éŸ³é¢‘æ–‡ä»¶");
            if (lyrics.length === 0) return alert("è¯·å…ˆä¸Šä¼ LRCæ–‡ä»¶");

            const btn = document.getElementById('recordBtn');
            const btnText = document.getElementById('recordBtnText');
            const dot = document.getElementById('recordDot');
            const downloadLink = document.getElementById('downloadLink');

            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                audio.pause();
                cancelAnimationFrame(animationId);
                btnText.innerText = "ğŸ¥ å¼€å§‹å½•åˆ¶è§†é¢‘";
                btn.classList.remove('bg-gray-600');
                btn.classList.add('bg-rose-600');
                dot.classList.add('hidden');
                document.getElementById('statusText').innerText = "å½•åˆ¶å®Œæˆï¼Œæ­£åœ¨å¤„ç†...";
            } else {
                initAudioContext();
                const canvasStream = canvas.captureStream(30); 
                const audioStream = dest.stream;
                const combinedStream = new MediaStream([...canvasStream.getVideoTracks(), ...audioStream.getAudioTracks()]);

                try {
                    mediaRecorder = new MediaRecorder(combinedStream, { mimeType: 'video/webm;codecs=vp9,opus' });
                } catch (e) {
                    mediaRecorder = new MediaRecorder(combinedStream, { mimeType: 'video/webm;codecs=vp8,opus' });
                }

                recordedChunks = [];
                mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    downloadLink.href = url;
                    downloadLink.download = `lyric_video_${Date.now()}.webm`;
                    downloadLink.classList.remove('hidden');
                    downloadLink.innerText = "â¬‡ï¸ ä¸‹è½½ç”Ÿæˆçš„è§†é¢‘ (.webm)";
                    document.getElementById('statusText').innerText = "è§†é¢‘å·²ç”Ÿæˆï¼Œè¯·ç‚¹å‡»ä¸‹è½½";
                };

                audio.currentTime = 0;
                smoothScrollIndex = 0; // é‡ç½®æ»šåŠ¨ä½ç½®
                audio.play();
                drawFrame();
                mediaRecorder.start();

                btnText.innerText = "â¹ åœæ­¢å½•åˆ¶ (ä¿å­˜)";
                btn.classList.remove('bg-rose-600');
                btn.classList.add('bg-gray-600');
                dot.classList.remove('hidden');
                downloadLink.classList.add('hidden');
                document.getElementById('statusText').innerText = "ğŸ”´ æ­£åœ¨å½•åˆ¶... è¯·è€å¿ƒç­‰å¾…æ­Œæ›²æ’­æ”¾";
            }
        }
    </script>
</body>
</html>